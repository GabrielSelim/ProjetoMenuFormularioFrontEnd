import React, { useState, useEffect } from 'react';
import {
  Box,
  Container,
  Typography,
  Paper,
  Grid,
  Card,
  CardContent,
  Button,
  Alert,
  CircularProgress,
  Divider,
  Chip,
  List,
  ListItem,
  ListItemText,
  ListItemAvatar,
  Avatar,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Snackbar
} from '@mui/material';
import {
  ArrowBack,
  Edit,
  Print,
  History,
  Assignment,
  CheckCircle,
  Cancel,
  Send,
  Person,
  CalendarToday,
  Description
} from '@mui/icons-material';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { submissionService, getAvailableActions, getAcaoLabel } from '../../api/submissionService';
import Header from '../../components/Header';
import Sidebar from '../../components/Sidebar';
import SubmissionStatus from '../../components/submissions/SubmissionStatus';
import FormRenderer from '../../components/FormRenderer';

const SubmissionView = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();

  // Estados principais
  const [submission, setSubmission] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  // Estados para a√ß√µes
  const [actionDialog, setActionDialog] = useState({
    open: false,
    type: '',
    title: '',
    message: '',
    requiresInput: false,
    inputLabel: '',
    inputValue: ''
  });

  useEffect(() => {
    loadSubmission();
  }, [id]);

  const loadSubmission = async () => {
    try {
      setLoading(true);
      setError('');
      
      const data = await submissionService.getById(id);
      setSubmission(data);
    } catch (error) {
      setError(error.message || 'Erro ao carregar submiss√£o');
      console.error('Erro ao carregar submiss√£o:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleWorkflowAction = (action) => {
    const actionConfigs = {
      enviar: {
        title: 'Enviar Submiss√£o',
        message: `Deseja enviar a submiss√£o "${submission?.formName}" para an√°lise?`,
        requiresInput: false
      },
      aprovar: {
        title: 'Aprovar Submiss√£o',
        message: `Deseja aprovar a submiss√£o "${submission?.formName}"?`,
        requiresInput: false
      },
      rejeitar: {
        title: 'Rejeitar Submiss√£o',
        message: `Deseja rejeitar a submiss√£o "${submission?.formName}"?`,
        requiresInput: true,
        inputLabel: 'Motivo da rejei√ß√£o (obrigat√≥rio)'
      },
      cancelar: {
        title: 'Cancelar Submiss√£o',
        message: `Deseja cancelar a submiss√£o "${submission?.formName}"?`,
        requiresInput: true,
        inputLabel: 'Motivo do cancelamento (obrigat√≥rio)'
      },
      colocarAnalise: {
        title: 'Colocar em An√°lise',
        message: `Deseja colocar a submiss√£o "${submission?.formName}" em an√°lise?`,
        requiresInput: false
      }
    };

    const config = actionConfigs[action];
    if (config) {
      setActionDialog({
        open: true,
        type: action,
        title: config.title,
        message: config.message,
        requiresInput: config.requiresInput,
        inputLabel: config.inputLabel || '',
        inputValue: ''
      });
    }
  };

  const handleActionConfirm = async () => {
    try {
      const { type, inputValue, requiresInput } = actionDialog;

      if (requiresInput && !inputValue.trim()) {
        setError('Campo obrigat√≥rio n√£o preenchido');
        return;
      }

      let response;
      const actionData = requiresInput ? { 
        motivo: inputValue.trim(),
        observacoes: inputValue.trim()
      } : {};

      switch (type) {
        case 'enviar':
          response = await submissionService.enviar(id, actionData);
          break;
        case 'aprovar':
          response = await submissionService.aprovar(id, actionData);
          break;
        case 'rejeitar':
          response = await submissionService.rejeitar(id, { motivo: inputValue.trim() });
          break;
        case 'cancelar':
          response = await submissionService.cancelar(id, { motivo: inputValue.trim() });
          break;
        case 'colocarAnalise':
          response = await submissionService.colocarAnalise(id, actionData);
          break;
        default:
          throw new Error('A√ß√£o n√£o reconhecida');
      }

      setSuccess(response.mensagem || 'A√ß√£o executada com sucesso!');
      setActionDialog({
        open: false,
        type: '',
        title: '',
        message: '',
        requiresInput: false,
        inputLabel: '',
        inputValue: ''
      });

      // Recarregar submiss√£o
      await loadSubmission();

    } catch (error) {
      setError(error.message || 'Erro ao executar a√ß√£o');
      console.error('Erro na a√ß√£o:', error);
    }
  };

  const handleActionCancel = () => {
    setActionDialog({
      open: false,
      type: '',
      title: '',
      message: '',
      requiresInput: false,
      inputLabel: '',
      inputValue: ''
    });
  };

  const renderFormData = () => {
    if (!submission?.dataJson) return null;

    try {
      const formData = JSON.parse(submission.dataJson);
      
      return (
        <Paper sx={{ p: 0, overflow: 'hidden' }}>
          {/* Header do Formul√°rio */}
          <Box sx={{ 
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            color: 'white',
            p: 3
          }}>
            <Typography variant="h5" gutterBottom sx={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: 1,
              fontWeight: 600
            }}>
              <Description /> {submission.formName}
            </Typography>
            <Typography variant="body1" sx={{ opacity: 0.9 }}>
              Dados preenchidos pelo usu√°rio
            </Typography>
          </Box>
          
          {/* Conte√∫do do Formul√°rio */}
          <Box sx={{ p: 3 }}>
            {Object.entries(formData).length === 0 ? (
              <Alert severity="info">
                Nenhum dado foi preenchido neste formul√°rio.
              </Alert>
            ) : (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
                {Object.entries(formData).map(([key, value], index) => {
                  // Formata√ß√£o mais inteligente dos valores
                  let displayValue = value;
                  let isLongText = false;
                  
                  if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value, null, 2);
                    isLongText = true;
                  } else if (typeof value === 'string' && value.length > 100) {
                    isLongText = true;
                    displayValue = value;
                  } else if (value === null || value === undefined || value === '') {
                    displayValue = '(n√£o preenchido)';
                  } else {
                    displayValue = String(value);
                  }
                  
                  return (
                    <Box key={key} sx={{ 
                      position: 'relative',
                      '&:not(:last-child)::after': {
                        content: '""',
                        position: 'absolute',
                        bottom: '-12px',
                        left: 0,
                        right: 0,
                        height: '1px',
                        background: 'linear-gradient(90deg, transparent, #e0e0e0, transparent)'
                      }
                    }}>
                      {/* Label do Campo */}
                      <Typography 
                        variant="subtitle1" 
                        sx={{ 
                          fontWeight: 600,
                          color: 'primary.main',
                          mb: 1,
                          textTransform: 'capitalize'
                        }}
                      >
                        {key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                      </Typography>
                      
                      {/* Valor do Campo */}
                      <Box sx={{
                        backgroundColor: '#f8f9fa',
                        border: '1px solid #e9ecef',
                        borderRadius: '8px',
                        p: 2,
                        minHeight: isLongText ? '100px' : '50px',
                        display: 'flex',
                        alignItems: isLongText ? 'flex-start' : 'center'
                      }}>
                        <Typography 
                          variant="body1" 
                          sx={{ 
                            fontSize: '1rem',
                            lineHeight: 1.5,
                            whiteSpace: isLongText ? 'pre-wrap' : 'normal',
                            color: displayValue === '(n√£o preenchido)' ? 'text.secondary' : 'text.primary',
                            fontStyle: displayValue === '(n√£o preenchido)' ? 'italic' : 'normal',
                            width: '100%'
                          }}
                        >
                          {displayValue}
                        </Typography>
                      </Box>
                    </Box>
                  );
                })}
              </Box>
            )}
          </Box>
          
          {/* Footer com informa√ß√µes extras */}
          <Box sx={{ 
            backgroundColor: '#f5f5f5',
            p: 2,
            borderTop: '1px solid #e0e0e0'
          }}>
            <Typography variant="caption" color="text.secondary">
              üìã {Object.entries(formData).length} campo(s) preenchido(s) ‚Ä¢ 
              üïê Submetido em {submission.createdAt && new Date(submission.createdAt).toLocaleString('pt-BR')}
            </Typography>
          </Box>
        </Paper>
      );
    } catch (error) {
      return (
        <Alert severity="warning">
          Erro ao processar dados do formul√°rio: {error.message}
        </Alert>
      );
    }
  };

  const renderHistorico = () => {
    if (!submission?.historicos || submission.historicos.length === 0) {
      return (
        <Alert severity="info">
          Nenhum hist√≥rico encontrado para esta submiss√£o.
        </Alert>
      );
    }

    return (
      <List>
        {submission.historicos.map((item, index) => (
          <ListItem key={index} alignItems="flex-start">
            <ListItemAvatar>
              <Avatar sx={{ bgcolor: 'primary.main' }}>
                <History />
              </Avatar>
            </ListItemAvatar>
            <ListItemText
              primary={`${getAcaoLabel(item.acao)} - ${item.usuarioName}`}
              secondary={
                <Box component="span">
                  <Box component="span" sx={{ display: 'block', color: 'text.secondary', fontSize: '0.875rem' }}>
                    {new Date(item.dataAcao).toLocaleString('pt-BR')}
                  </Box>
                  {item.comentario && (
                    <Box component="span" sx={{ display: 'block', mt: 1, fontSize: '0.875rem' }}>
                      {item.comentario}
                    </Box>
                  )}
                </Box>
              }
            />
          </ListItem>
        ))}
      </List>
    );
  };

  if (loading) {
    return (
      <Box sx={{ display: 'flex', minHeight: '100vh' }}>
        <Sidebar />
        <Box component="main" sx={{ flexGrow: 1 }}>
          <Header />
          <Container maxWidth="xl" sx={{ py: 3 }}>
            <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '400px' }}>
              <CircularProgress size={60} />
            </Box>
          </Container>
        </Box>
      </Box>
    );
  }

  if (error && !submission) {
    return (
      <Box sx={{ display: 'flex', minHeight: '100vh' }}>
        <Sidebar />
        <Box component="main" sx={{ flexGrow: 1 }}>
          <Header />
          <Container maxWidth="xl" sx={{ py: 3 }}>
            <Alert severity="error" sx={{ mb: 3 }}>
              {error}
            </Alert>
            <Button
              variant="contained"
              startIcon={<ArrowBack />}
              onClick={() => navigate('/submissions')}
            >
              Voltar para Lista
            </Button>
          </Container>
        </Box>
      </Box>
    );
  }

  const availableActions = submission ? getAvailableActions(submission, user?.role) : [];

  return (
    <Box sx={{ display: 'flex', minHeight: '100vh' }}>
      <Sidebar />
      <Box component="main" sx={{ flexGrow: 1 }}>
        <Header />
        <Container maxWidth="xl" sx={{ py: 3, mt: '80px' }}> {/* Adicionar margem superior */}
          {/* Cabe√ßalho */}
          <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
            <Button
              startIcon={<ArrowBack />}
              onClick={() => navigate('/submissions')}
              sx={{ mr: 2 }}
            >
              Voltar
            </Button>
            
            <Box sx={{ flexGrow: 1 }}>
              <Typography variant="h4" component="h1">
                üìã {submission?.formName}
              </Typography>
              <Typography variant="body1" color="text.secondary">
                Submiss√£o #{submission?.id}
              </Typography>
            </Box>
            
            {/* A√ß√µes do Cabe√ßalho */}
            <Box sx={{ display: 'flex', gap: 1 }}>
              {availableActions.includes('editar') && (
                <Button
                  variant="outlined"
                  startIcon={<Edit />}
                  onClick={() => navigate(`/submissions/${id}/edit`)}
                >
                  Editar
                </Button>
              )}
              
              <Button
                variant="outlined"
                startIcon={<Print />}
                onClick={() => window.print()}
              >
                Imprimir
              </Button>
            </Box>
          </Box>

          {/* Mensagens de Erro */}
          {error && (
            <Alert severity="error" sx={{ mb: 3 }} onClose={() => setError('')}>
              {error}
            </Alert>
          )}

          <Grid container spacing={3}>
            {/* Dados Principais */}
            <Grid item xs={12} md={8}>
              {renderFormData()}
            </Grid>

            {/* Informa√ß√µes Laterais */}
            <Grid item xs={12} md={4}>
              {/* Status e Informa√ß√µes */}
              <Card sx={{ mb: 3 }}>
                <CardContent>
                  <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Assignment /> Informa√ß√µes
                  </Typography>
                  
                  <Box sx={{ mb: 2 }}>
                    <Typography variant="body2" color="text.secondary" gutterBottom>
                      Status:
                    </Typography>
                    <SubmissionStatus status={submission?.status} />
                  </Box>
                  
                  <Box sx={{ mb: 2 }}>
                    <Typography variant="body2" color="text.secondary" gutterBottom>
                      <Person sx={{ fontSize: 16, mr: 0.5 }} />
                      Usu√°rio:
                    </Typography>
                    <Typography variant="body1">
                      {submission?.userName} ({submission?.userEmail})
                    </Typography>
                  </Box>
                  
                  <Box sx={{ mb: 2 }}>
                    <Typography variant="body2" color="text.secondary" gutterBottom>
                      <CalendarToday sx={{ fontSize: 16, mr: 0.5 }} />
                      Criado em:
                    </Typography>
                    <Typography variant="body1">
                      {submission?.createdAt && new Date(submission.createdAt).toLocaleString('pt-BR')}
                    </Typography>
                  </Box>
                  
                  {submission?.dataSubmissao && (
                    <Box sx={{ mb: 2 }}>
                      <Typography variant="body2" color="text.secondary" gutterBottom>
                        Submetido em:
                      </Typography>
                      <Typography variant="body1">
                        {new Date(submission.dataSubmissao).toLocaleString('pt-BR')}
                      </Typography>
                    </Box>
                  )}
                  
                  {submission?.dataAprovacao && (
                    <Box sx={{ mb: 2 }}>
                      <Typography variant="body2" color="text.secondary" gutterBottom>
                        Aprovado em:
                      </Typography>
                      <Typography variant="body1">
                        {new Date(submission.dataAprovacao).toLocaleString('pt-BR')}
                      </Typography>
                      {submission.usuarioAprovadorName && (
                        <Typography variant="body2" color="text.secondary">
                          Por: {submission.usuarioAprovadorName}
                        </Typography>
                      )}
                    </Box>
                  )}
                  
                  {submission?.motivoRejeicao && (
                    <Box sx={{ mb: 2 }}>
                      <Typography variant="body2" color="error" gutterBottom>
                        Motivo da Rejei√ß√£o:
                      </Typography>
                      <Typography variant="body1">
                        {submission.motivoRejeicao}
                      </Typography>
                    </Box>
                  )}

                  <Box sx={{ mb: 2 }}>
                    <Typography variant="body2" color="text.secondary" gutterBottom>
                      Vers√£o:
                    </Typography>
                    <Typography variant="body1">
                      {submission?.versao}
                    </Typography>
                  </Box>
                </CardContent>
              </Card>

              {/* A√ß√µes de Workflow */}
              {availableActions.length > 0 && (
                <Card sx={{ mb: 3 }}>
                  <CardContent>
                    <Typography variant="h6" gutterBottom>
                      ‚ö° A√ß√µes Dispon√≠veis
                    </Typography>
                    
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                      {availableActions.includes('enviar') && (
                        <Button
                          variant="contained"
                          startIcon={<Send />}
                          onClick={() => handleWorkflowAction('enviar')}
                          fullWidth
                        >
                          Enviar
                        </Button>
                      )}
                      
                      {availableActions.includes('colocarAnalise') && (
                        <Button
                          variant="contained"
                          startIcon={<Assignment />}
                          onClick={() => handleWorkflowAction('colocarAnalise')}
                          fullWidth
                          color="warning"
                        >
                          Colocar em An√°lise
                        </Button>
                      )}
                      
                      {availableActions.includes('aprovar') && (
                        <Button
                          variant="contained"
                          startIcon={<CheckCircle />}
                          onClick={() => handleWorkflowAction('aprovar')}
                          fullWidth
                          color="success"
                        >
                          Aprovar
                        </Button>
                      )}
                      
                      {availableActions.includes('rejeitar') && (
                        <Button
                          variant="outlined"
                          startIcon={<Cancel />}
                          onClick={() => handleWorkflowAction('rejeitar')}
                          fullWidth
                          color="error"
                        >
                          Rejeitar
                        </Button>
                      )}
                      
                      {availableActions.includes('cancelar') && (
                        <Button
                          variant="outlined"
                          startIcon={<Cancel />}
                          onClick={() => handleWorkflowAction('cancelar')}
                          fullWidth
                          color="error"
                        >
                          Cancelar
                        </Button>
                      )}
                    </Box>
                  </CardContent>
                </Card>
              )}

              {/* Hist√≥rico */}
              <Card>
                <CardContent>
                  <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <History /> Hist√≥rico
                  </Typography>
                  
                  <Divider sx={{ mb: 2 }} />
                  
                  {renderHistorico()}
                </CardContent>
              </Card>
            </Grid>
          </Grid>
        </Container>
      </Box>

      {/* Dialog de Confirma√ß√£o de A√ß√µes */}
      <Dialog
        open={actionDialog.open}
        onClose={handleActionCancel}
        maxWidth="sm"
        fullWidth
      >
        <DialogTitle>{actionDialog.title}</DialogTitle>
        <DialogContent>
          <Typography gutterBottom>
            {actionDialog.message}
          </Typography>
          
          {actionDialog.requiresInput && (
            <TextField
              autoFocus
              margin="dense"
              label={actionDialog.inputLabel}
              fullWidth
              multiline
              rows={3}
              variant="outlined"
              value={actionDialog.inputValue}
              onChange={(e) => setActionDialog(prev => ({
                ...prev,
                inputValue: e.target.value
              }))}
              sx={{ mt: 2 }}
            />
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={handleActionCancel}>Cancelar</Button>
          <Button 
            onClick={handleActionConfirm} 
            variant="contained"
            color={actionDialog.type === 'rejeitar' || actionDialog.type === 'cancelar' ? 'error' : 'primary'}
          >
            Confirmar
          </Button>
        </DialogActions>
      </Dialog>

      {/* Snackbar de Sucesso */}
      <Snackbar
        open={!!success}
        autoHideDuration={6000}
        onClose={() => setSuccess('')}
      >
        <Alert severity="success" onClose={() => setSuccess('')}>
          {success}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default SubmissionView;